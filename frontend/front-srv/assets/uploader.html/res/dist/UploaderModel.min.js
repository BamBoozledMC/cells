!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).UploaderModel=e()}(function(){return function r(o,i,s){function a(n,e){if(!i[n]){if(!o[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(u)return u(n,!0);t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}t=i[n]={exports:{}};o[n][0].call(t.exports,function(e){var t=o[n][1][e];return a(t||e)},t,t.exports,r,o,i,s)}return i[n].exports}for(var u="function"==typeof require&&require,e=0;e<s.length;e++)a(s[e]);return a}({1:[function(e,t,n){var r,o;r=this,o=function(){"use strict";function r(){this._listeners={}}r.prototype.addEventListener=function(e,t){this._listeners[e]=this._listeners[e]||[],this._listeners[e].indexOf(t)<0&&this._listeners[e].push(t)},r.prototype.removeEventListener=function(e,t){!this._listeners[e]||0<=(t=this._listeners[e].indexOf(t))&&this._listeners[e].splice(t,1)},r.prototype.dispatchEvent=function(e){if(this._listeners[e.type]&&this._listeners[e.type].length)for(var t=this._listeners[e.type].slice(),n=0,r=t.length;n<r;++n)t[n].call(this,e)};function o(e){var t=!1;return{next:function(){return t?{done:!0}:(t=!0,{value:e})}}}function n(e,t,n){this.target=e,this.type=t,this.data=n}function e(e,t,n){if(r.call(this),"number"!=typeof t||Math.floor(t)!==t||t<1)throw new Error("Invalid concurrency");this._concurrency=t,this._options=n||{},this._options.promise=this._options.promise||Promise,this._iterator=function(e,t){var n,r=typeof e;if("object"==r){if("function"==typeof e.next)return e;if("function"==typeof e.then)return o(e)}return"function"==r?"function"==typeof(r=e).constructor&&"GeneratorFunction"===r.constructor.name?e():(n=e,{next:function(){var e=n();return e?{value:e}:{done:!0}}}):o(t.resolve(e))}(e,this._options.promise),this._done=!1,this._size=0,this._promise=null,this._callbacks=null}return((e.prototype=new r).constructor=e).prototype.concurrency=function(e){return void 0!==e&&(this._concurrency=e,this.active()&&this._proceed()),this._concurrency},e.prototype.size=function(){return this._size},e.prototype.active=function(){return!!this._promise},e.prototype.promise=function(){return this._promise},e.prototype.start=function(){var n=this,e=this._options.promise;return this._promise=new e(function(e,t){n._callbacks={reject:t,resolve:e},n._proceed()}),this._promise},e.prototype._fireEvent=function(e,t){this.dispatchEvent(new n(this,e,t))},e.prototype._settle=function(e){e?this._callbacks.reject(e):this._callbacks.resolve(),this._promise=null,this._callbacks=null},e.prototype._onPooledPromiseFulfilled=function(e,t){this._size--,this.active()&&(this._fireEvent("fulfilled",{promise:e,result:t}),this._proceed())},e.prototype._onPooledPromiseRejected=function(e,t){this._size--,this.active()&&(this._fireEvent("rejected",{promise:e,error:t}),this._settle(t||new Error("Unknown error")))},e.prototype._trackPromise=function(t){var n=this;t.then(function(e){n._onPooledPromiseFulfilled(t,e)},function(e){n._onPooledPromiseRejected(t,e)}).catch(function(e){n._settle(new Error("Promise processing failed: "+e))})},e.prototype._proceed=function(){if(!this._done){for(var e={done:!1};this._size<this._concurrency&&!(e=this._iterator.next()).done;)this._size++,this._trackPromise(e.value);this._done=null===e||!!e.done}this._done&&0===this._size&&this._settle()},e.PromisePoolEvent=n,e.PromisePool=e},"object"==typeof n?t.exports=o():(r.PromisePool=o(),r.promisePool=r.PromisePool)},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=a(e("pydio")),i=a(e("pydio/util/path"));function a(e){return e&&e.__esModule?e:{default:e}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(u,a(e("pydio/lang/observable")).default),r(u,null,[{key:"getInstance",value:function(){return u.__INSTANCE||(u.__INSTANCE=new u),u.__INSTANCE}}]),r(u,[{key:"_loadOptions",value:function(){this._global||(this._global=s.default.getInstance().getPluginConfigs("uploader"))}},{key:"getOptionAsBool",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0,n=this.getOption(e,t,n);return!0===n||"true"===n}},{key:"getOption",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;if(this._loadOptions(),t){t=u.getUserPreference("originalUploadForm_XHRUploader",t);if(null!=t)return t}return this._global.has(e)?this._global.get(e):void 0!==n?n:null}},{key:"getAutoStart",value:function(){return this.getOptionAsBool("DEFAULT_AUTO_START","upload_auto_send")}},{key:"getAutoClose",value:function(){return this.getOptionAsBool("DEFAULT_AUTO_CLOSE","upload_auto_close")}},{key:"updateOption",value:function(e,t){2<arguments.length&&void 0!==arguments[2]&&arguments[2]&&(t=t?"true":"false"),u.setUserPreference("originalUploadForm_XHRUploader",e,t),this.notify("change")}},{key:"extensionAllowed",value:function(e){var t=this.getOption("ALLOWED_EXTENSIONS","","");if(t){var n=(n=this.getOption("ALLOWED_EXTENSIONS_READABLE","",""))&&" ("+n+")",e=i.default.getFileExtension(e.getLabel());if(-1===t.split(",").indexOf(e))throw new Error(s.default.getInstance().MessageHash[367]+t+n)}}}],[{key:"getUserPreference",value:function(e,t){var n=s.default.getInstance();if(!n.user)return null;var r=n.user.getPreference("gui_preferences",!0);return r&&r[e]?(n.user.activeRepository&&r[e]["repo-"+n.user.activeRepository]?r[e]["repo-"+n.user.activeRepository]:r[e])[t]:null}},{key:"setUserPreference",value:function(e,t,n){var r=s.default.getInstance();if(r&&r.user){var o=r.user.getPreference("gui_preferences",!0);if((o=o||{})[e]||(o[e]={}),r.user.activeRepository){var i="repo-"+r.user.activeRepository;if(o[e][i]||(o[e][i]={}),o[e][i][t]&&o[e][i][t]===n)return;o[e][i][t]=n}else{if(o[e][t]&&o[e][t]===n)return;o[e][t]=n}r.user.setPreference("gui_preferences",o,!0),r.user.savePreference("gui_preferences")}}}]),r=u;function u(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));return s.default.getInstance().observe("registry_loaded",function(){this._global=null}.bind(e)),e}n.default=r},{pydio:"pydio","pydio/lang/observable":"pydio/lang/observable","pydio/util/path":"pydio/util/path"}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}l(e("pydio"));var s=l(e("./StatusItem")),i=l(e("pydio/util/path")),a=l(e("pydio/http/api")),u=e("cells-sdk");function l(e){return e&&e.__esModule?e:{default:e}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(f,s.default),r(f,[{key:"isNew",value:function(){return this._new}},{key:"setIgnore",value:function(){this.setStatus(s.default.StatusLoaded),this.children.pg[this.getId()]=100,this.recomputeProgress(),this._new=!1}},{key:"_doProcess",value:function(t){var n=this;if(this._new){var e=void 0;try{e=this.getFullPath()}catch(e){return void this.setStatus(s.default.StatusError)}var r=new u.TreeServiceApi(a.default.getRestClient()),o=new u.RestCreateNodesRequest,i=new u.TreeNode;i.Path=e,i.Type=u.TreeNodeType.constructFromObject("COLLECTION"),o.Nodes=[i],r.createNodes(o).then(function(e){n.setStatus(s.default.StatusLoaded),n.children.pg[n.getId()]=100,n.recomputeProgress(),t()})}else t()}}]),r=f;function f(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f);t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(f.__proto__||Object.getPrototypeOf(f)).call(this,"folder",t,n));return t._new=!0,t._label=i.default.getBasename(e),t.children.pg[t.getId()]=0,n&&n.addChild(t),t}n.default=r},{"./StatusItem":6,"cells-sdk":"cells-sdk",pydio:"pydio","pydio/http/api":"pydio/http/api","pydio/util/path":"pydio/util/path"}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=s(e("./StatusItem"));s(e("pydio"));function s(e){return e&&e.__esModule?e:{default:e}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(a,i.default),r(a,[{key:"setProgress",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this._progress=e,this.notify("progress",e),null!==t&&this.notify("bytes",t)}}]),r=a;function a(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a);e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,"part",null,e));return e._label="Part "+t,e}n.default=r},{"./StatusItem":6,pydio:"pydio"}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=p(e("pydio")),u=p(e("pydio/http/api")),l=p(e("pydio/util/path")),s=p(e("pydio/util/lang")),a=p(e("./FolderItem")),f=p(e("./StatusItem")),c=p(e("es6-promise-pool")),d=e("cells-sdk");function p(e){return e&&e.__esModule?e:{default:e}}function h(e){return function(){var a=e.apply(this,arguments);return new Promise(function(i,s){return function t(e,n){try{var r=a[e](n),o=r.value}catch(e){return void s(e)}if(!r.done)return Promise.resolve(o).then(function(e){t("next",e)},function(e){t("throw",e)});i(o)}("next")})}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(y,a.default),r(y,[{key:"getAnalyzeStatus",value:function(){return this._analyzeStatus}},{key:"setAnalyzeStatus",value:function(e){this._analyzeStatus=e,this.notify("status",this._status)}},{key:"getFullPath",value:function(){var e=i.default.getInstance().user.getRepositoriesList();if(!e.has(this._repositoryId))throw new Error("Repository disconnected?");var t=e.get(this._repositoryId).getSlug(),e=this._targetNode.getPath();return e=t+(e=(e=s.default.trimRight(e,"/")).normalize?e.normalize("NFC"):e)}},{key:"treeViewFromMaterialPath",value:function(o){var t=[];return Object.keys(o).forEach(function(n){var e=n.split("/");e.shift();var r=t;e.forEach(function(t){var e=r.find(function(e){return e.name===t});r=e?e.children:(e={name:t,item:o[n],path:n,children:[]},r.push(e),e.children)})}),t}},{key:"bulkStatSliced",value:function(n,t,r){this.setAnalyzeStatus("checking "+t.length+" items");for(var o=Promise.resolve({Nodes:[]}),i=t.slice(0,r);i.length;)!function(){t=t.slice(r);var e=new d.RestGetBulkMetaRequest;e.NodePaths=i,o=o.then(function(t){return n.bulkStatNodes(e).then(function(e){return t.Nodes=t.Nodes.concat(e.Nodes||[]),t})}),i=t.slice(0,r)}();return o}},{key:"prepare",value:function(s){var a=this;if("overwrite"===s)return this.setStatus("ready"),Promise.resolve();var e=i.default.getInstance().getPluginConfigs("uploader.html").get("DEFAULT_STAT_SLICES"),t=400;e&&!isNaN(parseInt(e))&&(t=parseInt(e)),this.setStatus(f.default.StatusAnalyze);var n=new d.TreeServiceApi(u.default.getRestClient()),r=new d.RestGetBulkMetaRequest;return r.NodePaths=[],this.walk(function(e){r.NodePaths.push(e.getFullPath())},function(){return!0},"both"),new Promise(function(o,e){var i=[];a.bulkStatSliced(n,r.NodePaths,t).then(function(t){if(!t.Nodes||!t.Nodes.length)return a.setStatus("ready"),void o(i);if("alert"===s)return a.setStatus("confirm"),void o();function r(e){return-1!==t.Nodes.map(function(e){return e.Path}).indexOf(e.getFullPath())}var e,n=void 0,n=function(){var n=[];return a.walk(function(e){r(e)&&n.push(e)},function(){return!0},"file"),new c.default(function(){if(!n.length)return null;var t,r=n.pop();return new Promise((t=h(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.newPath(r.getFullPath());case 2:n=e.sent,n=l.default.getBasename(n),r.updateLabel(n),a.setAnalyzeStatus("checking "+n),t();case 7:case"end":return e.stop()}},e,a)})),function(e){return t.apply(this,arguments)}))},5).start()};"rename-folders"===s?(e=Promise.resolve(),a.walk(function(n){e=e.then(h(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r(n))return e.next=3,a.newPath(n.getFullPath());e.next=7;break;case 3:t=e.sent,t=l.default.getBasename(t),n.updateLabel(t),a.setAnalyzeStatus("checking "+t);case 7:case"end":return e.stop()}},e,a)})))},function(){return!0},"folder"),e.then(function(){return n()}).then(function(e){a.setStatus("ready"),o(e)})):(a.walk(function(e){r(e)&&e.setIgnore&&e.setIgnore()},function(){return!0},"folder"),n().then(function(e){a.setStatus("ready"),o(e)}))})})}},{key:"newPath",value:function(a){var t,u=this;return new Promise((t=h(regeneratorRuntime.mark(function e(t){var n,r,o,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=a.lastIndexOf("/"),s=a.lastIndexOf("."),n=a,r="",-1<s&&i<s&&i+1<s&&(n=a.substring(0,s),r=a.substring(s)),o=a,i=1,s=!0;case 8:if(s)return o=n+"-"+i+r,i++,e.next=13,u.nodeExists(o);e.next=16;break;case 13:s=e.sent,e.next=8;break;case 16:t(o);case 17:case"end":return e.stop()}},e,u)})),function(e){return t.apply(this,arguments)}))}},{key:"nodeExists",value:function(r){return new Promise(function(t){var e=new d.TreeServiceApi(u.default.getRestClient()),n=new d.RestGetBulkMetaRequest;n.NodePaths=[r],e.bulkStatNodes(n).then(function(e){e.Nodes&&e.Nodes[0]?t(!0):t(!1)}).catch(function(){return t(!1)})})}}]),r=y;function y(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,y);t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(y.__proto__||Object.getPrototypeOf(y)).call(this,"/",t));return t._repositoryId=e,t._status=f.default.StatusAnalyze,delete t.children.pg[t.getId()],t._analyzeStatus="",t}n.default=r},{"./FolderItem":3,"./StatusItem":6,"cells-sdk":"cells-sdk","es6-promise-pool":1,pydio:"pydio","pydio/http/api":"pydio/http/api","pydio/util/lang":"pydio/util/lang","pydio/util/path":"pydio/util/path"}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=a(e("pydio/lang/observable")),s=a(e("pydio"));function a(e){return e&&e.__esModule?e:{default:e}}function u(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(l,i.default),r(l,[{key:"getId",value:function(){return this._id}},{key:"getParent",value:function(){return this._parent}},{key:"getLabel",value:function(){return this._label.normalize?this._label.normalize("NFC"):this._label}},{key:"updateLabel",value:function(e){this._label=e}},{key:"getFullPath",value:function(){return this._parent.getFullPath()+"/"+this.getLabel()}},{key:"getProgress",value:function(){return this._progress}},{key:"setExists",value:function(){this._exists=!0}},{key:"getExists",value:function(){return this._exists}},{key:"getType",value:function(){return this._type}},{key:"getStatus",value:function(){return this._status}},{key:"setStatus",value:function(e){this._status=e,this.notify("status",e)}},{key:"updateRepositoryId",value:function(e){this._repositoryId=e}},{key:"getRepositoryId",value:function(){return this._repositoryId}},{key:"getErrorMessage",value:function(){return this._errorMessage||""}},{key:"onError",value:function(e){this._errorMessage=e,this.setStatus(l.StatusError)}},{key:"process",value:function(e){this._doProcess(e)}},{key:"abort",value:function(e){this._doAbort&&this._doAbort(e)}},{key:"pause",value:function(){var e;this._doPause&&(e=this._doPause(),this.setStatus(e))}},{key:"resume",value:function(){this._doResume&&(this._doResume(),this.setStatus(l.StatusLoading))}},{key:"addChild",value:function(t){var n=this;this.children.pg[t.getId()]=0,t.observe("progress",function(e){n.children.pg[t.getId()]=e,n.recomputeProgress()})}},{key:"recomputeProgress",value:function(){var e,t=this,n=Object.keys(this.children.pg).map(function(e){return t.children.pg[e]});n.length&&(e=n.reduce(function(e,t){return e+t}),this._progress=e/n.length,this.notify("progress",this._progress))}},{key:"removeChild",value:function(e){e.abort(),e.walk(function(e){e.abort()},function(){return!0},l.TypeFile);var t=e.getId(),n=this.children.folders.indexOf(e),r=this.children.files.indexOf(e),o=!1;-1<n?(this.children.folders=LangUtils.arrayWithout(this.children.folders,n),o=!0):-1<r&&(this.children.files=LangUtils.arrayWithout(this.children.files,r),o=!0),o&&(e.stopObserving("progress"),delete this.children.pg[t],this.recomputeProgress(),this.notify("children"))}},{key:"getChildren",value:function(){return[].concat(u(this.children.folders),u(this.children.files))}},{key:"walk",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){return!0},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:l.TypeBoth,o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(e){return!1},e=!1;if(r===l.TypeBoth||r===l.TypeFile)for(var i=this.children.files,s=0;s<i.length;s++){if(o(i[s])){e=!0;break}n(i[s])&&t(i[s])}e||this.children.folders.forEach(function(e){r!==l.TypeFolder&&r!==l.TypeBoth||!n(e)||t(e),o(e)||e.walk(t,n,r,o)})}},{key:"collectWithLimit",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){return!0},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"both",r=[];return this.walk(function(e){r.push(e)},e,n,function(e){return r.length>=t}),r}}]),r=l;function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));r._status=l.StatusNew,r._type=e,r._id=Math.random(),r._errorMessage=null;var o=s.default.getInstance();return r._repositoryId=n?n.getRepositoryId():o.user.activeRepository,r._exists=!1,r._progress=0,r.children={folders:[],files:[],pg:{}},r._targetNode=t,n&&(r._parent=n,(e===l.TypeFolder?n.children.folders:n.children.files).push(r)),r}r.StatusNew="new",r.StatusAnalyze="analyse",r.StatusLoading="loading",r.StatusLoaded="loaded",r.StatusError="error",r.StatusPause="pause",r.StatusCannotPause="cannot-pause",r.StatusMultiPause="multi-pause",r.TypeFolder="folder",r.TypeFile="file",r.TypeBoth="both",n.default=r},{pydio:"pydio","pydio/lang/observable":"pydio/lang/observable"}],7:[function(v,e,_){!function(f){"use strict";Object.defineProperty(_,"__esModule",{value:!0}),_.default=void 0;var e=function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e};function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=u(v("pydio")),n=u(v("pydio/util/lang")),d=u(v("pydio/util/path")),t=u(v("pydio/lang/observable")),o=u(v("./Task")),p=u(v("./Configs")),i=u(v("./StatusItem")),h=u(v("./UploadItem")),y=u(v("./FolderItem")),g=u(v("./Session")),s=u(v("pydio/http/api")),a=v("cells-sdk");function u(e){return e&&e.__esModule?e:{default:e}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(l,t.default),e(l,[{key:"getAutoStart",value:function(){return p.default.getInstance().getAutoStart()}},{key:"pushSession",value:function(e){var n=this;this._sessions.push(e),e.Task=o.default.create(e),e.observe("update",function(){n.notify("update")}),e.observe("children",function(){0===e.getChildren().length&&n.removeSession(e),n.notify("update")}),this.notify("update"),e.observe("status",function(e){var t;"ready"===e?!(t=n.getAutoStart())||n._processing.length||n._pauseRequired?t||l.openUploadDialog():n.processNext():"confirm"===e&&l.openUploadDialog(!0)}),this.notify("session_added",e)}},{key:"removeSession",value:function(e){e.Task.setIdle();e=this._sessions.indexOf(e);this._sessions=n.default.arrayWithout(this._sessions,e),this.notify("update")}},{key:"log",value:function(){}},{key:"hasQueue",value:function(){var t=0;return this._sessions.forEach(function(e){e.walk(function(){t++},function(e){return e.getStatus()===i.default.StatusNew||e.getStatus()===i.default.StatusPause||e.getStatus()===i.default.StatusMultiPause},"both",function(){return 1<=t})}),0<t}},{key:"hasErrors",value:function(){var t=0;return this._sessions.forEach(function(e){e.walk(function(){t++},function(e){return"error"===e.getStatus()},"both",function(){return 1<=t})}),0<t}},{key:"clearAll",value:function(){var t=this;this.clearStatus("new"),this._sessions.forEach(function(e){e.walk(function(e){e.getParent().removeChild(e)}),e.Task.setIdle(),t.removeSession(e)}),this._pauseRequired=!1,this.notify("update")}},{key:"clearStatus",value:function(t){this._sessions.forEach(function(e){e.walk(function(e){e.getParent().removeChild(e)},function(e){return e.getStatus()===t},"file")})}},{key:"monitorProcessing",value:function(e){var t=this;this._processingMonitor||(this._processingMonitor=function(){t.notify("update")}),e.observe("status",this._processingMonitor),this._processing.push(e)}},{key:"unmonitorProcessing",value:function(e){var t=this._processing.indexOf(e);-1<t&&(this._processingMonitor&&e.stopObserving("status",this._processingMonitor),this._processing=n.default.arrayWithout(this._processing,t))}},{key:"processNext",value:function(){var n=this,e=this.getFolders();if(e.length&&!this._pauseRequired){var t=new a.TreeServiceApi(s.default.getRestClient()),r=new a.RestCreateNodesRequest;return r.Nodes=[],e.forEach(function(e){var t=new a.TreeNode;t.Path=e.getFullPath(),t.Type=a.TreeNodeType.constructFromObject("COLLECTION"),r.Nodes.push(t),e.setStatus(i.default.StatusLoading),n.monitorProcessing(e)}),this.notify("update"),void t.createNodes(r).then(function(){e.forEach(function(e){e.setStatus(i.default.StatusLoaded),e.children.pg[e.getId()]=100,e.recomputeProgress(),n.unmonitorProcessing(e)}),n.processNext(),n.notify("update")}).catch(function(e){n.processNext(),n.notify("update")})}t=this.getNexts();t.length&&!this._pauseRequired?t.forEach(function(e){n.monitorProcessing(e),e.process(function(){n.unmonitorProcessing(e),n.processNext(),n.notify("update")})}):this.hasErrors()?l.openUploadDialog():p.default.getInstance().getAutoClose()&&!this._pauseRequired&&this.notify("auto_close"),this.notify("update")}},{key:"getFolders",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:60,n=[];return this._sessions.forEach(function(e){e.walk(function(e){n.push(e)},function(e){return"new"===e.getStatus()&&e.isNew()},"folder",function(){return n.length>=t})}),n}},{key:"getNexts",value:function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:3,t=[];if(this._sessions.forEach(function(e){e.walk(function(e){t.push(e)},function(e){return"new"===e.getStatus()&&e.isNew()},"folder",function(){return 1<=t.length})}),t.length)return[t.shift()];var r=[],o=this._processing.length;return this._sessions.forEach(function(e){var t=0;e.walk(function(e){r.push(e),t++},function(e){return"new"===e.getStatus()||"pause"===e.getStatus()},"file",function(){return r.length>=n-o}),0===t&&e.Task.setIdle()}),r}},{key:"stopOrRemoveItem",value:function(e){e.abort(),this.unmonitorProcessing(e),this.notify("update")}},{key:"getSessions",value:function(){return this._sessions}},{key:"isRunning",value:function(){return 0<this._processing.filter(function(e){return e.getStatus()===i.default.StatusLoading}).length}},{key:"pause",value:function(){this._pauseRequired=!0,this._processing.forEach(function(e){return e.pause()}),this.notify("update")}},{key:"resume",value:function(){this._pauseRequired=!1,this._sessions.forEach(function(e){return e.setStatus("ready")}),this._processing.forEach(function(e){return e.resume()}),this.notify("update"),this.processNext()}},{key:"handleFolderPickerResult",value:function(e,o){var i=this,t=p.default.getInstance().getOption("DEFAULT_EXISTING","upload_existing"),n=new g.default(c.default.getInstance().user.activeRepository,o);this.pushSession(n);for(var r={},s=0;s<e.length;s++){var a,u=e[s],l="/"+d.default.getBasename(u.name);e[s].webkitRelativePath&&(l="/"+e[s].webkitRelativePath,"/"!==(a=d.default.getDirname(l))&&(r[d.default.getDirname(a)]="FOLDER"),r[a]="FOLDER"),r[l]=u}(function n(e,r){e.forEach(function(e){var t;"FOLDER"===e.item?(t=new y.default(e.path,o,r),n(e.children,t)):-1===i._blacklist.indexOf(d.default.getBasename(e.path).toLowerCase())&&new h.default(e.item,o,e.path,r)})})(n.treeViewFromMaterialPath(r),n),n.prepare(t).catch(function(e){})}},{key:"handleDropEventResults",value:function(r,e,s){var o=this,t=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,n=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,a=p.default.getInstance().getOption("DEFAULT_EXISTING","upload_existing"),u=new g.default(n||c.default.getInstance().user.activeRepository,s);this.pushSession(u);function l(e){return!(t&&!t(e))&&-1===o._blacklist.indexOf(d.default.getBasename(e).toLowerCase())}if(r&&r.length&&(r[0].getAsEntry||r[0].webkitGetAsEntry))!function(){for(var i=f.console?f.console.log:function(e){f.alert(e)},e=r.length,n=[],t=0;t<e;t++)(function(e){var t=void 0;if(r[e].kind&&"file"!==r[e].kind)return;(t=r[0].getAsEntry?r[e].getAsEntry():r[e].webkitGetAsEntry()).isFile?n.push(new Promise(function(n,e){t.file(function(e){var t=void 0;0<e.size&&l(e.name)&&(t=new h.default(e,s,null,u)),n(t)},function(){e(),i()})})):t.isDirectory&&(t.folderItem=new y.default(t.fullPath,s,u),n.push(o.recurseDirectory(t,function(r){var o=r.fullPath;return new Promise(function(n,t){r.file(function(e){var t=void 0;0<e.size&&l(e.name)&&(t=new h.default(e,s,o,r.parentItem)),n(t)},function(e){t(e),i()})})},function(e){return l(e.fullPath)&&(e.folderItem=new y.default(e.fullPath,s,e.parentItem)),Promise.resolve(e.folderItem)},i)))})(t);Promise.all(n).then(function(){return u.prepare(a).then(function(){o.notify("update")})}).catch(function(e){o.notify("update")})}();else{for(var i=0;i<e.length;i++){if(0===e[i].size)return void alert(c.default.getInstance().MessageHash["html_uploader.no-folders-support"]);if(!l(e[i].name))return;new h.default(e[i],s,null,u)}u.prepare(a).then(function(){o.notify("update")}).catch(function(e){o.notify("update")})}}},{key:"recurseDirectory",value:function(e,r,o,t){var i=this;return new Promise(function(n){i.dirEntries(e).then(function(e){var t=[];e.forEach(function(e){e.parent&&e.parent.folderItem&&(e.parentItem=e.parent.folderItem),e.isDirectory?t.push(o(e)):t.push(r(e))}),Promise.all(t).then(function(){n()})})})}},{key:"dirEntries",value:function(o){var i=this,e=o.createReader(),s=[];return new Promise(function(r,t){(function n(){e.readEntries(function(e){var t;e.length?(s=s.concat((e=e,Array.prototype.slice.call(e||[],0))),n()):(t=[],s.forEach(function(e){e.parent=o,e.isDirectory&&t.push(i.dirEntries(e).then(function(e){s=s.concat(e)}))}),t.length?Promise.all(t).then(function(){r(s)}):r(s))},function(e){t(e)})})()})}}],[{key:"openUploadDialog",value:function(){0<arguments.length&&void 0!==arguments[0]&&arguments[0]?c.default.getInstance().getController().fireAction("upload",{confirmDialog:!0}):c.default.getInstance().getController().fireAction("upload")}},{key:"getInstance",value:function(){return l.__INSTANCE||(l.__INSTANCE=new l),l.__INSTANCE}}]),e=l;function l(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return e._processing=[],e._sessions=[],e._blacklist=[".ds_store",".pydio"],e._pauseRequired=!1,e}_.default=e}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./Configs":2,"./FolderItem":3,"./Session":5,"./StatusItem":6,"./Task":8,"./UploadItem":9,"cells-sdk":"cells-sdk",pydio:"pydio","pydio/http/api":"pydio/http/api","pydio/lang/observable":"pydio/lang/observable","pydio/util/lang":"pydio/util/lang","pydio/util/path":"pydio/util/path"}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=u(e("pydio")),s=e("cells-sdk"),a=u(e("./StatusItem"));function u(e){return e&&e.__esModule?e:{default:e}}var l=i.default.requireLib("boot").JobsStore,r=(r(f,[{key:"setIdle",value:function(){this.task.Status=s.JobsTaskStatus.constructFromObject("Idle"),this.task.StatusMessage="",this.notifyMainStore()}},{key:"notifyMainStore",value:function(){this.task.StartTime=(new Date).getTime()/1e3,this.job.Tasks=[this.task],l.getInstance().enqueueLocalJob(this.job)}}],[{key:"create",value:function(e){return new f(e)}}]),f);function f(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),pydio=i.default.getInstance(),this.job=new s.JobsJob,this.job.ID="local-upload-task-"+t.getId(),this.job.Owner=pydio.user.id,this.job.Label=pydio.MessageHash["html_uploader.task.label"],this.job.Stoppable=!0;var r=new s.JobsTask;this.task=r,this.job.Tasks=[this.task],this.task.HasProgress=!0,this.task.ID="upload",this.task.Status=s.JobsTaskStatus.constructFromObject("Idle"),this.job.openDetailPane=function(){pydio.Controller.fireAction("upload")},r._statusObserver=function(e){e===a.default.StatusAnalyze?(n.job.Label="Preparing files for upload",t.getChildren().length?r.StatusMessage="Analyzing ("+t.getChildren().length+") items":r.StatusMessage="Please wait...",r.Status=s.JobsTaskStatus.constructFromObject("Running")):"ready"===e?(n.job.Label=pydio.MessageHash["html_uploader.7"],r.StatusMessage="Ready to upload",r.Status=s.JobsTaskStatus.constructFromObject("Idle")):"paused"===e&&(n.job.Label="Task paused",r.Status=s.JobsTaskStatus.constructFromObject("Paused")),n.notifyMainStore()},r._progressObserver=function(e){r.Progress=e/100,r.Status=s.JobsTaskStatus.constructFromObject("Running"),0<e&&(r.StatusMessage="Uploading "+Math.ceil(e)+"%"),n.notifyMainStore()},t.observe("status",r._statusObserver),t.observe("progress",r._progressObserver),r._statusObserver(t.getStatus()),r._progressObserver(t.getProgress()),l.getInstance().enqueueLocalJob(this.job)}n.default=r},{"./StatusItem":6,"cells-sdk":"cells-sdk",pydio:"pydio"}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=c(e("./StatusItem")),i=c(e("./PartItem")),l=c(e("pydio")),s=c(e("pydio/util/path")),a=c(e("pydio/http/api")),f=c(e("./Configs"));e("cells-sdk");function c(e){return e&&e.__esModule?e:{default:e}}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)})(d,u.default),r(d,[{key:"createParts",value:function(){var e=a.default.getMultipartPartSize();this._parts=[];for(var t=0;t<Math.ceil(this._file.size/e);t++)this._parts.push(new i.default(this,t+1))}},{key:"getFile",value:function(){return this._file}},{key:"getSize",value:function(){return this._file.size}},{key:"getHumanSize",value:function(){return s.default.roundFileSize(this._file.size)}},{key:"setProgress",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this._progress=e,this.notify("progress",e),null!==t&&this.notify("bytes",t)}},{key:"_parseXHRResponse",value:function(){this.xhr&&this.xhr.responseText&&"OK"!==this.xhr.responseText&&this.onError("Unexpected response: "+this.xhr.responseText)}},{key:"_doProcess",value:function(t){var o=this;this._userAborted=!1;function n(){o.setStatus(u.default.StatusLoaded),o._parseXHRResponse(),t()}function r(e){var t,n,r;o._status!==u.default.StatusError&&e.total&&(n=Math.round(100*e.loaded/e.total),r=e.loaded,o.setProgress(n,r),o._parts&&e.part&&o._parts[e.part-1]&&e.partLoaded&&e.partTotal&&(t=o._parts[e.part-1],(n=Math.round(100*e.partLoaded/e.partTotal))<100?t.getStatus()!==u.default.StatusCannotPause&&t.setStatus(u.default.StatusLoading):(r=t.getStatus()===u.default.StatusCannotPause,t.setStatus(u.default.StatusLoaded),r&&0===o._parts.filter(function(e){return t.getStatus()===u.default.StatusCannotPause}).length&&o.setStatus(u.default.StatusPause)),t.setProgress(n,e.partLoaded)))}function i(e){o.onError(a[210]+": "+e.message),t()}function s(t){return function(e){if(e&&e.indexOf){if(0<=e.indexOf("422"))return void i(new Error(a["html_uploader.status.error.422"]+" (422)"));if(0<=e.indexOf("403"))return void i(new Error(a["html_uploader.status.error.403"]+" (403)"))}o._userAborted?i(e||new Error(a["html_uploader.status.error.aborted"])):2<=t?i(e):window.setTimeout(function(){o.uploadPresigned(n,r,s(++t))},150*t)}}var a=l.default.getMessages();this.setStatus(u.default.StatusLoading);try{f.default.getInstance().extensionAllowed(this)}catch(e){return this.onError(e.message),void t()}s(0)()}},{key:"_doAbort",value:function(e){if(this.xhr)try{this._userAborted=!0,this.xhr.abort()}catch(e){}this.setStatus(u.default.StatusError),this.setProgress(0)}},{key:"_doPause",value:function(){return this.xhr?this.xhr.pause?(this.xhr.pause(),this._parts&&this._parts.length&&this._parts.filter(function(e){return e.getStatus()===u.default.StatusLoading}).forEach(function(e){return e.setStatus(u.default.StatusCannotPause)}),u.default.StatusMultiPause):u.default.StatusCannotPause:u.default.StatusNew}},{key:"_doResume",value:function(){this.xhr&&this.xhr.resume&&this.xhr.resume()}},{key:"uploadPresigned",value:function(e,t,n){var r=this,o=void 0;try{o=this.getFullPath()}catch(e){return this.setStatus(u.default.StatusError),void this.setProgress(0)}this.getSize()<a.default.getMultipartThreshold()?a.default.getClient().uploadPresigned(this._file,o,e,n,t).then(function(e){r.xhr=e}):a.default.getClient().uploadMultipart(this._file,o,e,n,t).then(function(e){r.xhr=e})}}]),r=d;function d(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d);t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,"file",t,r));return t._file=e,t._status="new",t._label=n?s.default.getBasename(n):e.name,e.size>a.default.getMultipartThreshold()&&t.createParts(),r&&r.addChild(t),t}n.default=r},{"./Configs":2,"./PartItem":4,"./StatusItem":6,"cells-sdk":"cells-sdk",pydio:"pydio","pydio/http/api":"pydio/http/api","pydio/util/path":"pydio/util/path"}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PartItem=n.Session=n.FolderItem=n.UploadItem=n.Configs=n.Store=void 0;var r=u(e("./Store")),o=u(e("./Configs")),i=u(e("./UploadItem")),s=u(e("./FolderItem")),a=u(e("./PartItem")),e=u(e("./Session"));function u(e){return e&&e.__esModule?e:{default:e}}n.Store=r.default,n.Configs=o.default,n.UploadItem=i.default,n.FolderItem=s.default,n.Session=e.default,n.PartItem=a.default},{"./Configs":2,"./FolderItem":3,"./PartItem":4,"./Session":5,"./Store":7,"./UploadItem":9}]},{},[10])(10)});