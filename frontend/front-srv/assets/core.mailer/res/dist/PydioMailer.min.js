!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).PydioMailer=e()}(function(){return function r(a,n,o){function i(s,e){if(!n[s]){if(!a[s]){var t="function"==typeof require&&require;if(!e&&t)return t(s,!0);if(l)return l(s,!0);t=new Error("Cannot find module '"+s+"'");throw t.code="MODULE_NOT_FOUND",t}t=n[s]={exports:{}};a[s][0].call(t.exports,function(e){var t=a[s][1][e];return i(t||e)},t,t.exports,r,a,n,o)}return n[s].exports}for(var l="function"==typeof require&&require,e=0;e<o.length;e++)i(o[e]);return i}({1:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s,r=arguments[t];for(s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},r=function(e,t,s){return t&&a(e.prototype,t),s&&a(e,s),e};function a(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var n=function(e,t,s){for(var r=!0;r;){var a=e,n=t,o=s,r=!1;null===a&&(a=Function.prototype);var i=Object.getOwnPropertyDescriptor(a,n);if(void 0!==i){if("value"in i)return i.value;var l=i.get;return void 0===l?void 0:l.call(o)}a=Object.getPrototypeOf(a);if(null===a)return;e=a,t=n,s=o,r=!0,i=void 0}};function o(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var p=o(e("react")),d=o(e("prop-types")),c=o(e("pydio/http/api")),h=e("material-ui"),f=e("cells-sdk"),g={chip:{marginRight:4,marginBottom:4},wrapper:{display:"flex",flexWrap:"wrap"},overlay:{position:"absolute",top:0,right:0,left:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.33)",paddingTop:77,zIndex:100}},m=(l(y,p["default"].Component),r(y,[{key:"render",value:function(){var e=this.props.user;return p.default.createElement("div",{className:"share-dialog user-badge user-type-"+(e.getTemporary()?"tmp_user":"user")},p.default.createElement("span",{className:"avatar icon-"+(e.getTemporary()?"envelope":"user")}),p.default.createElement("span",{className:"user-badge-label"},e.getExtendedLabel()||e.getLabel()))}}]),y);function y(){i(this,y),n(Object.getPrototypeOf(y.prototype),"constructor",this).apply(this,arguments)}var v=(l(b,p["default"].Component),r(b,[{key:"render",value:function(){var e=this.props,t=e.user,s=e.onRemove,r=t.FreeValue,a=void 0,a=r?t.FreeValue:t.Attributes&&t.Attributes.displayName?t.Attributes.displayName:t.Login,e=p.default.createElement(h.FontIcon,{className:"icon-"+(r?"envelope":"user")}),t=h.Style.colors;return p.default.createElement(h.Chip,{backgroundColor:r?t.lightBlue100:t.blueGrey100,onRequestDelete:function(){s()},style:g.chip},p.default.createElement(h.Avatar,{icon:e,color:r?"white":t.blueGrey600,backgroundColor:r?t.lightBlue300:t.blueGrey300}),a)}}]),b);function b(){i(this,b),n(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}var k=(r(j,[{key:"addTarget",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1],s=arguments.length<=2||void 0===arguments[2]?null:arguments[2],r=arguments.length<=3||void 0===arguments[3]?null:arguments[3];this._targets.push(e),t&&this._subjects.push(t),s&&this._messages.push(s),r&&this._links.push(r)}},{key:"setTemplateData",value:function(e,t){this.templateId=e,this.templateData=t}},{key:"postOne",value:function(e,t,s,r){var a=new f.MailerServiceApi(c.default.getRestClient()),n=new f.MailerMail;return n.Subject=t,n.To=e.map(function(e){return f.MailerUser.constructFromObject({Uuid:e})}),n.TemplateId=s,n.TemplateData=r,a.send(n)}},{key:"post",value:function(){var r=this,t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];if(!this._subjects.length&&!this.templateId||!this._targets.length||!this._messages.length)throw new Error("Invalid data");var e,a=u({},this.templateData),n=[];1<this._messages.length&&this._messages.length===this._targets.length&&this._subjects.length===this._targets.length?this._targets.map(function(e,t){var s=r._subjects[t];a=u({},a,{Message:r._messages[t]}),n.push(r.postOne([e],s,r.templateId,a))}):(e=this._subjects[0],a.Message=this._messages[0],n.push(this.postOne(this._targets,e,this.templateId,a))),Promise.all(n).then(function(){t(!0)}).catch(function(e){e.response&&e.response.body&&e.response.body.Title&&(e=new Error(e.response.body.Title)),t(!1,e)})}}]),j);function j(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0],t=arguments.length<=1||void 0===arguments[1]?null:arguments[1],s=arguments.length<=2||void 0===arguments[2]?null:arguments[2];i(this,j),this._subjects=[],this._messages=[],this._targets=[],this._links=[],this.templateId="",this.templateData={},e&&this._subjects.push(e),t&&this._messages.push(t),s&&this._links.push(s)}l(E,p["default"].Component),r(E,[{key:"updateSubject",value:function(e){this.setState({subject:e.currentTarget.value})}},{key:"updateMessage",value:function(e){this.setState({message:e.currentTarget.value})}},{key:"addUser",value:function(e){var t=this.state.users;e.FreeValue?t[e.FreeValue]=e:e.IdmUser&&(t[e.IdmUser.Login]=e.IdmUser),this.setState({users:t,errorMessage:null})}},{key:"removeUser",value:function(e){var t=this.state.users;delete t[e],this.setState({users:t})}},{key:"getMessage",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1];try{return(e=void 0===e?"core.mailer":e)&&(e+="."),pydio.MessageHash[e+t]}catch(e){return t}}},{key:"postEmail",value:function(){var e,t,s,r=this,a=!(arguments.length<=0||void 0===arguments[0])&&arguments[0],n=this.state,o=n.users,i=n.subject,l=n.message;if(!a&&this.refs.completer&&this.refs.completer.getPendingSearchText&&this.refs.completer.getPendingSearchText())return this.refs.completer.onCompleterRequest(this.refs.completer.getPendingSearchText(),-1),void setTimeout(function(){return r.postEmail(!0)},500);Object.keys(o).length?(e=(t=this.props).link,n=t.templateId,a=t.templateData,t=function(e,t){r.setState({posting:!1}),e?(r.props.pydio.UI.displayMessage("SUCCESS",r.props.pydio.MessageHash["core.mailer.1"].replace("%s",Object.keys(o).length)),r.props.onDismiss?r.props.onDismiss():r.setState({users:{},subject:"",message:""})):r.props.pydio.UI.displayMessage("ERROR",r.props.pydio.MessageHash["core.mailer.sender.error"]+(t?" : "+t.message:""))},this.setState({posting:!0}),this.props.processPost?this.props.processPost(k,o,i,l,e,t):(s=new k(i,l,e||null),Object.keys(o).forEach(function(e){s.addTarget(e)}),n&&s.setTemplateData(n,a),s.post(t))):this.setState({errorMessage:this.getMessage(2)})}},{key:"render",value:function(){var t=this,e=this.state,s=e.users,r=e.posting,a=e.errorMessage,n=e.subject,o=e.message,i=[this.props.className,"react-mailer","reset-pydio-forms"].join(" "),l=Object.keys(s).map(function(e){var t=this;return p.default.createElement(v,{key:e,user:s[e],onRemove:function(){t.removeUser(e)}})}.bind(this)),e=void 0;a&&(e=p.default.createElement("div",{style:{padding:"10px 20px",color:"red"}},a));a=u({margin:this.props.uniqueUserStyle?0:8},this.props.style),r=p.default.createElement(h.Paper,{zDepth:void 0!==this.props.zDepth?this.props.zDepth:2,className:i,style:a},p.default.createElement("h3",{style:u({padding:20,color:"rgba(0,0,0,0.87)",fontSize:25,marginBottom:0,paddingBottom:10},this.props.titleStyle)},this.props.panelTitle),e,this.props.additionalPaneTop,!this.props.uniqueUserStyle&&p.default.createElement("div",{className:"users-block",style:u({padding:"0 20px"},this.props.usersBlockStyle)},p.default.createElement(PydioComponents.UsersCompleter,{ref:"completer",fieldLabel:this.getMessage("8"),usersOnly:!0,existingOnly:!0,freeValueAllowed:!0,onValueSelected:this.addUser.bind(this),excludes:Object.keys(s),renderSuggestion:function(e){return p.default.createElement(m,{user:e})},pydio:pydio,showAddressBook:this.props.showAddressBook,underlineHide:!0}),p.default.createElement("div",{style:g.wrapper},l)),!this.props.uniqueUserStyle&&p.default.createElement(h.Divider,null),!this.props.templateId&&p.default.createElement("div",{style:{padding:"0 20px"}},p.default.createElement(h.TextField,{fullWidth:!0,underlineShow:!1,floatingLabelText:this.getMessage("6"),value:n,onChange:this.updateSubject.bind(this)})),!this.props.templateId&&p.default.createElement(h.Divider,null),p.default.createElement("div",{style:u({padding:"0 20px"},this.props.messageBlockStyle)},p.default.createElement(h.TextField,{fullWidth:!0,underlineShow:!1,floatingLabelText:this.getMessage("7"),value:o,multiLine:!0,onChange:this.updateMessage.bind(this),rowsMax:6})),this.props.additionalPaneBottom,p.default.createElement(h.Divider,null),p.default.createElement("div",{style:{textAlign:"right",padding:"8px 20px"}},this.props.onDismiss&&p.default.createElement(h.FlatButton,{label:this.getMessage("54",""),onClick:this.props.onDismiss}),!this.props.onDismiss&&p.default.createElement(h.FlatButton,{label:this.getMessage("216",""),onClick:function(){t.setState({users:{},subject:"",message:""})}}),p.default.createElement(h.FlatButton,{disabled:r,primary:!0,label:this.getMessage("77",""),onClick:function(e){return t.postEmail()}})));return this.props.overlay?p.default.createElement("div",{style:g.overlay},r):r}}]),e=E;function E(e){i(this,E),void 0===e.showAddressBook&&(e.showAddressBook=!0),n(Object.getPrototypeOf(E.prototype),"constructor",this).call(this,e),this.state={users:this.props.users||{},subject:this.props.subject,message:this.props.message,errorMessage:null,posting:!1}}e.PropTypes={message:d.default.string,subject:d.default.string,templateId:d.default.string,templateData:d.default.object,link:d.default.string,onDismiss:d.default.func,className:d.default.string,overlay:d.default.bool,uniqueUserStyle:d.default.bool,users:d.default.object,panelTitle:d.default.string,zDepth:d.default.number,showAddressBook:d.default.bool,processPost:d.default.func,additionalPaneTop:d.default.instanceOf(p.default.Component),additionalPaneBottom:d.default.instanceOf(p.default.Component)};l(O,p["default"].Component),r(O,[{key:"render",value:function(){return p.default.createElement("div",null,"Preferences Panel")}}]),r=O;function O(){i(this,O),n(Object.getPrototypeOf(O.prototype),"constructor",this).apply(this,arguments)}s.Pane=e,s.PreferencesPanel=r},{"cells-sdk":"cells-sdk","material-ui":"material-ui","prop-types":"prop-types","pydio/http/api":"pydio/http/api",react:"react"}],2:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});e=e("./components");s.Pane=e.Pane,s.PreferencesPanel=e.PreferencesPanel},{"./components":1}]},{},[2])(2)});